---
layout: post
title: Heroku log drains
date: 2016-03-28
comments: true
---

At [Shopify](http://shopify.com), we use Heroku to host a lot of Rails applications.
Lately, I've been working on a log analyzer service for Heroku apps.
In this post I am going to describe specifics of processing logs from Heroku.

Heroku provides [log drains](https://devcenter.heroku.com/articles/log-drains), a way to stream app logs to your own endpoint.
Logs can be streamed over HTTP or over [syslog protocol](https://tools.ietf.org/html/rfc5424).

For Shopify apps, we decided to stream logs over HTTP for some reasons.
If you chose HTTP, Heroku will still use syslog format for the streamed logs.
To reduce amount of HTTP requests, Heroku [Logplex](https://devcenter.heroku.com/articles/logging) will also batch log items using the
[syslog TCP protocol octet counting framing method](https://tools.ietf.org/html/rfc6587#section-3.4.1).

That framing method is quite uncommon and partly that's the reason why I'm writing this post.
Here is an example batch of 4 framed logs that Heroku will POST to your HTTP endpoint:

{% highlight text %}
130 <190>1 2016-03-28T10:54:28.238791+00:00 host app web.2 - Started GET "/posts.json" for 23.227.37.104 at 2016-03-28 10:54:28 +0000
101 <190>1 2016-03-28T10:54:28.241995+00:00 host app web.2 - Processing by PostsController#index as JSON
122 <190>1 2016-03-28T10:54:28.443173+00:00 host app web.2 - Completed 200 OK in 200ms (Views: 20.2ms | ActiveRecord: 14.9ms)
142 <172>1 2016-03-28T10:54:36+00:00 host heroku logplex - Error L10 (output buffer overflow): 2 messages dropped since 2016-03-28T10:47:51+00:00.309 <45>1 2016-03-28T10:54:36.563347+00:00 host heroku worker.1 - source=worker.1 dyno=heroku.8651552.b5611dc9-9f88-4c37-b3e1-9702b2855b
{% endhighlight %}

First 3 records are generated by a request to the Rails app and the last one is a warning from Heroku platform.
Heroku batched those 4 log lines into one and formatted them with syslog format.

The actual syslog message is only the part of the log line:

{% highlight text %}
<190>1 2016-03-28T10:54:28.241995+00:00 host app web.2 - Processing by PostsController#index as JSON
{% endhighlight %}

That part can be parsed with [RFC5424](http://www.rfc-base.org/rfc-5424.html) into the following structure:

{% highlight ruby %}
{
  :priority=>190,
  :syslog_version=>1,
  :emitted_at=>2016-03-28 10:54:28 UTC,
  :hostname=>"host",
  :appname=>"app",
  :proc_id=>"web.2",
  :msg_id=>nil,
  :structured_data=>nil,
  :message=>"Processing by PostsController#index as JSON"
}
{% endhighlight %}

But if you look on the log line that comes from Heroku, you will notice few more symbols before `<190>` (the message).
It comes from the octet counting framing. The number means length of syslog message.
We can write a small self explanatory method in Ruby:

{% highlight ruby %}
def parse_frames(body)
  frames = []
  body = StringIO.new(body)
  until body.eof? do
    # read until the first space to get the frame number
    limit = body.gets(" ")
    # read the message of <length> characters
    frames << body.gets(limit.to_i).strip
  end
  frames
end
{% endhighlight %}

This method will filter frames and return syslog events in RFC5424.

After lines are filtered, we can parse them with `syslog-parser` gem:

{% highlight ruby %}
require "syslog/parser"
parser = Syslog::Parser.new(allow_missing_structured_data: true)

frames = parse_frames(body)

frames.each do |line|
  message = parser.parse(line)
  puts message.inspect
end
{% endhighlight %}

{% highlight ruby %}
#<struct Message prival=190, version=1, timestamp=2016-03-28 10:54:28 +0000, hostname="host", app_name="app", procid="web.2", msgid=nil, structured_data=nil, msg="Started GET \"/posts.json\" for 23.227.37.104 at 2016-03-28 10:54:28 +0000">
#<struct Message prival=190, version=1, timestamp=2016-03-28 10:54:28 +0000, hostname="host", app_name="app", procid="web.2", msgid=nil, structured_data=nil, msg="Processing by PostsController#index as JSON">
#<struct Message prival=190, version=1, timestamp=2016-03-28 10:54:28 +0000, hostname="host", app_name="app", procid="web.2", msgid=nil, structured_data=nil, msg="Completed 200 OK in 200ms (Views: 20.2ms | ActiveRecord: 14.9ms)">
#<struct Message prival=172, version=1, timestamp=2016-03-28 10:54:36 +0000, hostname="host", app_name="heroku", procid="logplex", msgid=nil, structured_data=nil, msg="Error L10 (output buffer overflow): 2 messages dropped since 2016-03-28T10:47:51+00:00.">
#<struct Message prival=45, version=1, timestamp=2016-03-28 10:54:36 +0000, hostname="host", app_name="heroku", procid="worker.1", msgid=nil, structured_data=nil, msg="source=worker.1 dyno=heroku.8651552.b5611dc9-9f88-4c37-b3e1-9702b2855b">
{% endhighlight %}

## References

* [rfc5424 spec](http://tools.ietf.org/html/rfc5424)
* [Heroku logdrains guide](https://devcenter.heroku.com/articles/log-drains)
